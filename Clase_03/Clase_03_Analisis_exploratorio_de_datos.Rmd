---
title: "Clase 03 - Análisis exploratorio de datos"
author: Dr. José A. Gallardo  |  <jose.gallardo@pucv.cl>  |  Pontificia Universidad
  Católica de Valparaíso
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  beamer_presentation:
        includes:
            in_header: mystyle.tex
subtitle: 'Curso Análisis de datos con R para Biociencias'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(MASS)
library(psych)
library(ggplot2)
library(fishdata)
library(pander)
library(dplyr)
require(gridExtra)
library(grid)
```

## PLAN DE LA CLASE
**1.- Introducción**
    
- ¿Qué es un análisis exploratorio de datos?.
- ¿Por qué es importante?.
- Recomendaciones para comunicar datos de forma efectiva.

**2.- Práctica con R y Rstudio cloud**

- Actividad de aprendizaje ggplot2.
- Realizar un análisis exploratorio de datos.
- Realizar gráficas avanzadas con ggplot2. 

## ANÁLISIS EXPLORATORIO DE DATOS (EDA)

**¿Qué es un análisis exploratorio de datos?**  
Procedimiento que permite visualizar y explorar los datos de un estudio.  
**¿Para qué?**  
1- Investigar calidad de los datos brutos.  

2- Limpiar datos.  

3- Observar variación de los datos.  

4- Establecer un modelo básico de relación e interacción entre variables.  

5- Seleccionar una prueba estadÍstica adecuada.   

## EDA ES UN PROCESO ITERATIVO

**¿Cómo realizar un buen EDA?**

1- Genera preguntas iniciales para explorar tus datos.

2- Resume, visualiza, transforma y modela tus datos.

3- Usa lo que aprendiste para generar nuevas preguntas.

**Preguntas clave, pero no las únicas**  

- ¿Qué tipo de variación existe en la/s variables de estudio?  

- ¿Qué tipo de covariación o interacción existe entre las variables de estudio?  

- ¿Cuál es el modelo más simple que explica la relación entre variables?

- ¿Existen errores, datos faltantes, valores atípicos?

## EDA: IMPORTANCIA DE LA ESTRUCTURA DE LOS DATOS

**¿Mis datos son balanceados o no balanceados?**

```{r}
set.seed(123)
tilapia<-data.frame(chickwts)
sex<-rbinom(71, 1, 0.8)
dat<-data.frame(tilapia, sex)
dat$sex <- factor(dat$sex, labels=c("Macho","Hembra"))
dat$feed <- factor(dat$feed, labels=c("d1", "d2", "d3", "d4", "d5", "d6"))
tabla<- table(dat$sex, dat$feed)

knitr::kable(tabla, caption = "Diseño no balanceado con datos faltantes")

# Exporta datos 
# write.table(dat, file="tilapia.xlsx", sep = ";", col.names = TRUE, dec=".")
```

## EDA: VARIACIÓN DENTRO DE UN FACTOR

**¿La variación de mis datos es homogenea?**

```{r}
set.seed(123)

My_Theme = theme(
  axis.title.x = element_text(size = 18),
  axis.text.x = element_text(size = 18),
  axis.title.y = element_text(size = 18),
  axis.text.y = element_text(size = 18))


genotipo     <- rbinom(1000, 2, 0.5)
w.means <- c(3000, 6000, 9000) # Complete dominance
w.sd    <- c(800, 800, 800)
weight <- rnorm(1000, w.means[factor(genotipo)], w.sd[factor(genotipo)])
snp.w <- data.frame(cbind(genotipo, weight))

snp.w$genotipo<-as.factor(snp.w$genotipo)
snp.w$genotipo <- factor(snp.w$genotipo, labels=c("AA", "AC", "CC"))

g <- ggplot(snp.w, aes(x = weight)) +
  geom_histogram(aes(color = genotipo), 
  position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800", "blue")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800", "blue"))
g+My_Theme


generacion     <- rbinom(10000, 1, 0.5)
w.means <- c(3000, 3500) # Complete dominance
w.sd    <- c(400, 400)
weight <- rnorm(1000, w.means[factor(generacion)], w.sd[factor(generacion)])
snp.w <- data.frame(cbind(generacion, weight))

snp.w$generacion<-as.factor(snp.w$generacion)
snp.w$generacion <- factor(snp.w$generacion, labels=c("Base", "F1"))

g <- ggplot(snp.w, aes(x = weight)) +
  geom_histogram(aes(color = generacion), 
  position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
g+My_Theme
# Exporta datos 
# write.table(snp.w, file="genotipos.xlsx", sep = ";", col.names = TRUE, dec=".")
```

## EDA: INTERACCIÓN ENTRE FACTORES

**¿Existe interacción entre los factores?**


```{r, echo=FALSE, out.width = '90%' }
knitr::include_graphics("GxE.jpeg")
```

## EDA: TAMAÑO DE LOS EFECTOS

**¿Qué factor tiene un mayor efecto sobre la variable respuesta?**

```{r}
plot.design(dat$weight ~ dat$sex + dat$feed, col = c(2), xlab="", xaxt="n", yaxt="n", ylab = "weight", cex.axis = 1.5)
axis(1, 1:2, c("Sex", "Feed"), cex.axis = 1.5)
axis(2, cex.axis = 1.5)
```
  
## EDA: CORRELACIÓN ENTRE VARIABLES CONTINUAS

**¿Existe covariación / correlación entre mis datos?**

```{r fig.cap="Distribución normal multivariada, out.width = '80%'"}
# Número de animales (n) y promedios (prom) de peso y filete filete
set.seed(123)
par(mfrow=c(1,2))
n <- c(20)
prom  <- c(10, 10)

# matriz de varianzas y covarianzas entre WFE y filete TrimD
covar <- matrix(c(3, 2.5, 2.5, 3), nrow = 2, ncol = 2)

# Crea muestra de variables correlacionadas
cor_pos <- data.frame(mvrnorm(n, prom, covar))
names(cor_pos) <- c("X", "Y")
plot(cor_pos$X, cor_pos$Y, col ="blue", pch=20, xlab = "X", ylab = "Y", main = "Relación lineal positiva", cex.axis = 1.5)
abline(lm(cor_pos$Y ~ cor_pos$X), col="blue")

cor_neg <- mutate(cor_pos,
  X = X,
  Y = Y * (-1))

plot(cor_neg$X, cor_neg$Y, col ="red", pch=20, xlab = "X", ylab = "Y", main ="Relación lineal negativa", cex.axis = 1.5)
abline(lm(cor_neg$Y ~ cor_neg$X), col="red")


```

## EDA: OTRAS CORRELACIONES

```{r}
set.seed(123)
par(mfrow=c(1,2))
X <- runif(n = 20,min = 0,max = 10)
Y <- rnorm(20, 10, 3)
plot(X, Y, col ="green", pch=20, xlab = "X", ylab = "Y", main="Sin relación", cex.axis = 1.5)

set.seed(123)
x <- 1:20
y <- (1/4) * x^2 # Funcion monotona creciente


plot(x, y, type = 'b', main = 'Relación no lineal', frame.plot = FALSE, col = "dark red", lwd=2, font=2, cex.axis = 1.5)
```


## COMUNICAR EDA DE FORMA EFECTIVA

**Evita las tortas**

```{r, , echo=FALSE, out.width = '80%' }

# Pie Chart with Percentages
count.data <- data.frame(
  Especie = c("Trucha", "Salmon del Pacifico", "Salmón del Atlántico"),
  n = c(35, 74, 279),
  prop = c(9, 19, 72)
)



# Add label position
count.data <- count.data %>%
  arrange(desc(Especie)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)

mycols <- c("#0073C2FF", "#EFC000FF", "#CD534CFF")

ggplot(count.data, aes(x = "", y = prop, fill = Especie)) +
  geom_bar(width = 2, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = prop), color = "white", size=12)+
  scale_fill_manual(values = mycols) +
  theme_void(base_size = 12)



```

## SOLUCIÓN

**Prefiere datos brutos y barras**

```{r}
# Grafica de barras
centros <- c(35, 74, 279)
Especie = c("Trucha", "Salmon del Pacifico", "Salmón del Atlántico")
salmon<-data.frame(Especie, centros)
s<- ggplot(data=salmon, aes(x=Especie, y=centros)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=centros), vjust=1.6, color="white", size=5)+
  theme_minimal()
s+ My_Theme
```

## COMUNICAR EDA DE FORMA EFECTIVA 2

**Evita gráficas de barras para comparar grupos**

```{r, warning=FALSE, message=FALSE}
set.seed(123)
fctr <- rbinom(40, 1, 0.8)
w.means <- c(30, 35) # Complete dominance
w.sd    <- c(5, 5)
weight <- rnorm(40, w.means[factor(fctr)], w.sd[factor(fctr)])
camaron <- data.frame(cbind(fctr, weight))

camaron$fctr<-as.factor(camaron$fctr)
camaron$fctr <- factor(camaron$fctr, labels=c("Control", "Tratamiento"))

Camaron_summary <- camaron %>% # the names of the new data frame and the data frame to be summarised
  group_by(fctr) %>%   # the grouping variable
  summarise(mean_CA = mean(weight),  # calculates the mean of each group
            sd_CA = sd(weight), # calculates the standard deviation of each group
            n_CA = n(),  # calculates the sample size per group
            SE_CA = sd(weight)/sqrt(n())) # calculates the standard error of each group

camaronPlot <- ggplot(Camaron_summary, aes(fctr, mean_CA)) + 
                   geom_col(fill = "#0073C2FF") +  
                   geom_errorbar(aes(ymin = mean_CA - sd_CA, ymax = mean_CA + sd_CA), width=0.5)

camaronPlot + labs(y="weight (g) ± s.d.", x = "") + theme_minimal() + My_Theme
```

## SOLUCIÓN

**Prefiere boxplot, muestra tus datos ¡¡ **

```{r}
camaronBoxplot<- ggplot(camaron, aes(x=fctr, y=weight, fill=fctr)) +
    geom_boxplot() +
    geom_jitter(color="blue", size=2, alpha=1) +
    theme_minimal() + 
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    xlab("")
camaronBoxplot + My_Theme + labs(y="weight (g) ± s.d.", x = "")
```

## VISUALIZACIÓN DE DATOS AVANZADO CON GGPLOT2
\columnsbegin
\column{.8\textwidth}
**ggplot2**: Librería de visualización de datos preferido para realizar graficas con R [Wickham en 2005]()).

**Ventajas**
Gran flexibilidad.
Sistema para realizar gráficos completo y maduro.
Una gran comunidad de desarrolladores.

**Características**
Los datos siempre deben ser un data.frame.
Usa un sistema diferente para añadir elementos al gráfico.

\column{.2\textwidth}
```{r, echo=FALSE, out.width = '80%' }
knitr::include_graphics("ggplot2_logo.png")
```
\columnsend


## COMPARACIÓN GGPLOT2 - GRAPHICS

Comparación de algunos comandos de gráficas entre la librería **graphics** y **ggplot2**

| Función  |  graphics |  ggplot2 |
|---|---|---|
| Función genérica para graficar  |  plot() | ggplot()  |
|  Histogramas |  hist() | geom_histogram() |
|  Gráfica de cajas y bigotes | boxplot()  |  geom_boxplot() |
|Etiquetar ejes | xlab="" , ylab=""| labs(x="", y="")|

## ¿CÓMO FUNCIONA GGPLOT2?

**ggplot2 funciona por capas**

```{r, echo=TRUE, out.width = '80%' }
ggplot(CO2, aes(uptake))
```

## HISTOGRAMAS CON GGPLOT2

```{r, echo=TRUE, out.width = '80%', message=FALSE}
ggplot(CO2, aes(uptake))+
 geom_histogram()+
  labs(title="Histograma", x="Consumo de CO2", 
       y="Frecuencia")
```

## BOXPLOT CON GGPLOT2

```{r, echo=TRUE, out.width = '80%', message=FALSE}
ggplot(CO2, aes(x=Treatment, y=uptake))+
 geom_boxplot()+
  labs(title="Boxplot", x="Tratamiento", 
       y="Consumo de CO2")
```

## PRÁCTICA ANÁLISIS DE DATOS

1.- Guía de trabajo Rmarkdown disponible en drive.  

2.- La tarea se realiza en Rstudio.cloud.

## RESUMEN DE LA CLASE

- Identificamos la importancia de los análisis exploratorio de datos.

- Realizamos gráficas avanzadas con ggplot2.  

- Conocemos algunas recomendaciones para comunicar EDA de forma efectiva.
